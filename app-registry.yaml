apps:
  - slug: galaxypro
    name: Galaxy Pro
    status: LIVE
    summary: |-
      Galaxy Pro - A production grade Galaxy genomics workbench.
    maintainer: GalaxyWorks LLC
    description: |-
      Galaxy Pro offers Galaxy as a fully managed, production-grade subscription service with enhanced usage capabilities,
      increased security, and quality of service guarantees.
    info_url: https://galaxyworks.io
    icon_url: https://galaxyworks.io/logo.svg
    display_order: 950
    default_version: 1.0.0
    default_launch_config:
      config_cloudlaunch:
        firewall:
        - rules:
          - cidr: 0.0.0.0/0
            from: '80'
            protocol: tcp
            to: '80'
          - cidr: 0.0.0.0/0
            from: '20'
            protocol: tcp
            to: '22'
          - cidr: 0.0.0.0/0
            from: '22'
            protocol: tcp
            to: '22'
          - cidr: 0.0.0.0/0
            from: '30000'
            protocol: tcp
            to: '30100'
          - cidr: 0.0.0.0/0
            from: '1'
            protocol: tcp
            src_group: cloudlaunch-gpro
            to: '65535'
          securityGroup: cloudlaunch-gpro
        provider_settings:
          ebsOptimised: true
        vmType: m5.2xlarge
      config_gvl:
        config_cloudman:
          cluster_templates:
          - filesystem_templates:
            - name: galaxy
              roles: galaxyTools,galaxyData
            - name: galaxyIndices
              roles: galaxyIndices
            name: Galaxy
          - filesystem_templates:
            - name: galaxy
              type: transient
            name: Data
          masterPostStartScript: |-
            file:///opt/gvl/scripts/triggers;file:///mnt/galaxy/gvl/poststart.d
    versions:
    - version: 1.0.0
      frontend_component_path: |-
        app/marketplace/plugins/plugins.module#PluginsModule
      frontend_component_name: clui-cm2-config
      backend_component_name: |-
        galaxy-pro-launch.plugins.galaxy_pro_app.GalaxyProApp
      default_launch_config:
        config_appliance:
          runner: ansible
          sshUser: ubuntu
          playbooks:
            - url: https://github.com/CloudVE/ansible-docker-boot
              inventory_template: |-
                ${host}

                [all:vars]
                ansible_ssh_port=22
                ansible_user='${user}'
                ansible_ssh_private_key_file=pk
                ansible_ssh_extra_args='-o StrictHostKeyChecking=no'
        config_cloudlaunch:
          firewall:
          - rules:
            - cidr: 0.0.0.0/0
              from: '22'
              protocol: tcp
              to: '22'
            - cidr: 0.0.0.0/0
              from: '80'
              protocol: tcp
              to: '80'
            - cidr: 0.0.0.0/0
              from: '443'
              protocol: tcp
              to: '443'
            - cidr: 0.0.0.0/0
              from: '4430'
              protocol: tcp
              to: '4430'
            - cidr: 0.0.0.0/0
              from: '6443'
              protocol: tcp
              to: '6443'
            - cidr: 0.0.0.0/0
              from: '2379'
              protocol: tcp
              to: '2380'
            - cidr: 0.0.0.0/0
              from: '10250'
              protocol: tcp
              to: '10250'
            - cidr: 0.0.0.0/0
              from: '10251'
              protocol: tcp
              to: '10251'
            - cidr: 0.0.0.0/0
              from: '10252'
              protocol: tcp
              to: '10252'
            - cidr: 0.0.0.0/0
              from: '10256'
              protocol: tcp
              to: '10256'
            - cidr: 0.0.0.0/0
              from: '30000'
              protocol: tcp
              to: '32767'
            - from: '1'
              protocol: tcp
              src_group: cloudlaunch-cm2
              to: '65535'
            - from: '1'
              protocol: udp
              src_group: cloudlaunch-cm2
              to: '65535'
            securityGroup: cloudlaunch-cm2
          vmType: m1.medium
        config_cloudman2:
          cm_boot_image: galaxyworks/galaxy-pro-boot:1.0.0
          cm_helm_values: |
            cluster_type: KUBE_RANCHER
            rancher_url: "https://{{ rancher_server }}:{{ rancher_port }}"
            rancher_api_key: "{{ token }}"
            rancher_cluster_id: "{{ cluster_id }}"
            rancher_project_id: "{{ project_id }}"
            cm_initial_cluster_data: "{{ cm_initial_cluster_data|default('') }}"

            helmsman_config:
              repositories:
                 - name: galaxyworks
                   url: https://raw.githubusercontent.com/galaxy-works/helm-charts/1.0.0/
              charts:
                cvmfs:
                  name: galaxyworks/galaxy-cvmfs-csi
                  namespace: cvmfs
                  values:
                    cache:
                      size: 30000
                galaxy:
                  name: galaxyworks/galaxy
                  namespace: initial
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: node-role.kubernetes.io/controlplane
                            operator: In
                            values:
                            - "true"
                  oidc_client:
                    client_secret: {{ random_client_secret }}
                    redirect_uris:
                      - '{{ '{{' }} include "cloudman.root_url" . {{ '}}{{' }} .Values.helmsman_config.charts.galaxy.values.ingress.path {{ '}}' }}/authnz/custos/callback'
                  tplValues:
                    configs:
                      oidc_backends_config.xml: |
                        <?xml version="1.0"?>
                        <OIDC>
                            <provider name="custos">
                                <url>https://{{ rancher_server }}/auth</url>
                                <client_id>galaxy-auth</client_id>
                                <client_secret>{{ '{{' }}.Values.helmsman_config.charts.galaxy.oidc_client.client_secret {{ '}}' }}</client_secret>
                                <redirect_uri>https://{{ rancher_server }}{{ '{{' }} .Values.helmsman_config.charts.galaxy.values.ingress.path {{ '}}' }}/authnz/custos/callback</redirect_uri>
                                <realm>master</realm>
                                <enable_idp_logout>true</enable_idp_logout>
                            </provider>
                        </OIDC>
                  values:
                    webHandlers:
                      podAnnotations:
                        backup.velero.io/backup-volumes: galaxy-data
                    resources:
                      requests:
                        cpu: 300m
                        memory: 2000Mi
                      limits:
                        cpu: 3000m
                        memory: 7000Mi
                    jobs:
                      rules:
                        container_mapper_rules.yml: |
                          mappings:
                            - tool_ids:
                                - Summary_Statistics1
                              container:
                                docker_container_id_override: galaxyworks/gsummary:1.0.0
                                resource_set: small
                            - tool_ids:
                                - toolshed.g2.bx.psu.edu/repos/devteam/data_manager_sam_fasta_index_builder/sam_fasta_index_builder/.*
                              container:
                                docker_container_id_override: galaxyworks/sam-fasta-dm:1.0.0
                                resource_set: small
                            - tool_ids:
                                - toolshed.g2.bx.psu.edu/repos/devteam/data_manager_bwa_mem_index_builder/bwa_mem_index_builder_data_manager/.*
                              container:
                                docker_container_id_override: galaxyworks/bwa-dm:1.0.0
                                resource_set: small
                            - tool_ids:
                                - toolshed.g2.bx.psu.edu/repos/iuc/pygenometracks/pygenomeTracks/3.2.1
                              container:
                                docker_container_id_override: galaxyworks/pygenometracks:latest
                                resource_set: small
                            - tool_ids:
                                - sort1
                                - Grouping1
                              container:
                                docker_container_id_override: {{ '{{' }} .Values.image.repository {{ '}}:{{' }} .Values.image.tag {{ '}}' }}
                                resource_set: small
                            - tool_ids:
                                - param_value_from_file
                              container:
                                docker_container_id_override: cloudve/param_value_from_file:latest
                                resource_set: small
                            - tool_ids:
                                - read_mapping_viz
                                - snp_substitution_viz
                                - variant_summary_viz
                              container:
                                docker_container_id_override: galaxyworks/customviztools:1.0.0
                                resource_set: small
                            - tool_ids:
                                - toolshed.g2.bx.psu.edu/repos/devteam/bowtie2/bowtie2/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/bwameth/bwameth/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/featurecounts/featurecounts/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/hisat2/hisat2/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/valet/valet/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/varscan_somatic/varscan_somatic/.*
                                - toolshed.g2.bx.psu.edu/repos/nilesh/rseqc/rseqc_bam2wig/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/snippy/snippy/.*
                              container:
                                resource_set: medium
                            - tool_ids:
                                - toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa/.*
                                - toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_bam_compare/deeptools_bam_compare/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_bam_coverage/deeptools_bam_coverage/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_bam_pe_fragmentsize/deeptools_bam_pe_fragmentsize/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_bigwig_compare/deeptools_bigwig_compare/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_compute_gc_bias/deeptools_compute_gc_bias/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_compute_matrix/deeptools_compute_matrix/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_correct_gc_bias/deeptools_correct_gc_bias/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_multi_bam_summary/deeptools_multi_bam_summary/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/deeptools_multi_bigwig_summary/deeptools_multi_bigwig_summary/.*
                                - toolshed.g2.bx.psu.edu/repos/devteam/freebayes/freebayes/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/rgrnastar/rna_star/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/rnaspades/rnaspades/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/sra_tools/fasterq_dump/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/porechop/porechop/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/medaka_consensus/medaka_consensus/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/medaka_consensus_pipeline/medaka_consensus_pipeline/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/medaka_variant/medaka_variant/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/medaka_variant_pipeline/medaka_variant_pipeline/.*
                              container:
                                resource_set: large
                            - tool_ids:
                                - toolshed.g2.bx.psu.edu/repos/iuc/unicycler/unicycler/.*
                                - toolshed.g2.bx.psu.edu/repos/nml/spades/spades/.*
                                - toolshed.g2.bx.psu.edu/repos/bgruening/flye/flye/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/bandage/bandage_info/.*
                                - toolshed.g2.bx.psu.edu/repos/iuc/bandage/bandage_image/.*
                              container:
                                resource_set: 2xlarge
                            - tool_ids:
                                - toolshed.g2.bx.psu.edu/repos/iuc/minimap2/minimap2/.*
                              container:
                                resource_set: mlarge
                            - tool_ids:
                                - advaita_send_DE_data
                                - advaita_send_VCF_data
                              container:
                                docker_container_id_override: {{ '{{' }} .Values.image.repository {{ '}}:{{' }} .Values.image.tag {{ '}}' }}
                          resources:
                            resource_sets:
                              small:
                                requests:
                                  cpu: 1
                                  memory: 2G
                                limits:
                                  cpu: 2
                                  memory: 5G
                              medium:
                                requests:
                                  cpu: 2
                                  memory: 4G
                                limits:
                                  cpu: 4
                                  memory: 10G
                              large:
                                requests:
                                  cpu: 4
                                  memory: 8G
                                limits:
                                  cpu: 8
                                  memory: 16G
                              2xlarge:
                                requests:
                                  cpu: 12
                                  memory: 20G
                                limits:
                                  cpu: 12
                                  memory: 24G
                              mlarge:
                                requests:
                                  cpu: 2
                                  memory: 16G
                                limits:
                                  cpu: 4
                                  memory: 20G
                            default_resource_set: small
                    image:
                      repository: galaxyworks/galaxy-pro
                      tag: 20.01-1.0.0
                    configs:
                      galaxy.yml:
                        galaxy:
                          session_duration: 30
                          smtp_server: {{ galaxy_pro_smtp_server }}
                          smtp_ssl: true
                          smtp_username: {{ galaxy_pro_smtp_username }}
                          smtp_password: {{ galaxy_pro_smtp_password }}
                          error_email_to: support@galaxyworks.io
                          email_from: support@galaxyworks.io
                          instance_resource_url: https://galaxyworks.io/
                          ga_code:
                          enable_old_display_applications: false
                          interactivetools_enable: false
                          visualizations_visible: false
                          brand:
                          user_preferences_extra_conf_path:
                          logo_url: /
                          logo_src: https://galaxyworks.io/logo.svg
                          require_login: true
                          helpsite_url: https://galaxyworks.io/
                          wiki_url: https://galaxyworks.io/
                          support_url: mailto:support@galaxyworks.io
                          citation_url: https://galaxyworks.io/
                          search_url: https://galaxyworks.io/
                          terms_url: https://galaxyworks.io/
                          qa_url: https://galaxyworks.io/
                          allow_user_creation: false
                          enable_beta_gdpr: true
                          enable_tool_tags: true
                          auth_config_file: config/auth_conf.xml
                          tool_config_file: "/galaxy/server/config/shed_tool_conf.xml,/galaxy/server/config/tool_conf.xml"
                      auth_conf.xml: |
                        <?xml version="1.0"?>
                        <auth>
                        </auth>
                      integrated_tool_panel.xml: |
                        <?xml version="1.0"?>
                        <toolbox>
                            <section id="get_data" name="Get Data" version="">
                            </section>
                            <section id="collection_operations" name="Collection Operations" version="">
                            </section>
                            <label id="general_text_label" text="General Text Tools" version="" />
                            <section id="text_manipulation" name="Text Manipulation" version="">
                            </section>
                            <section id="filter_and_sort" name="Filter and Sort" version="">
                                <label id="gff" text="GFF" version="" />
                            </section>
                            <section id="join_subtract_and_group" name="Join, Subtract and Group" version="">
                            </section>
                            <section id="datamash" name="Datamash" version="">
                            </section>
                            <label id="genomic_file_manipulation_label" text="Genomic File Manipulation" version="" />
                            <section id="fasta_fastq" name="FASTA/FASTQ" version="">
                            </section>
                            <section id="fastq_quality_control" name="FASTQ Quality Control" version="">
                            </section>
                            <section id="sam_bam" name="SAM/BAM" version="">
                                <label id="bamtools_label" text="BAMTools" version="" />
                                <label id="samtools_label" text="SAMTools" version="" />
                            </section>
                            <section id="bed" name="BED" version="">
                                <label id="bedtools_label" text="BEDTools" version="" />
                            </section>
                            <section id="vcf_bcf" name="VCF/BCF" version="">
                                <label id="vcflib_label" text="vcflib" version="" />
                                <label id="vcftools_label" text="VCFTools" version="" />
                                <label id="bcftools_label" text="BCFTools" version="" />
                            </section>
                            <section id="convert_formats" name="Convert Formats" version="">
                            </section>
                            <section id="nanopore" name="Nanopore" version="">
                            </section>
                            <label id="common_genomics_tools_label" text="Common Genomics Tools" version="" />
                            <section id="operate_on_genomic_intervals" name="Operate on Genomic Intervals" version="">
                            </section>
                            <section id="fetch_sequences_alignments" name="Fetch Sequences/Alignments" version="">
                            </section>
                            <label id="genomics_analysis_label" text="Genomics Analysis" version="" />
                            <section id="assembly" name="Assembly" version="">
                            </section>
                            <section id="annotation" name="Annotation" version="">
                            </section>
                            <section id="mapping" name="Mapping" version="">
                            </section>
                            <section id="variant_calling" name="Variant Calling" version="">
                            </section>
                            <section id="rna_seq" name="RNA-seq" version="">
                            </section>
                            <section id="chip_seq" name="ChIP-seq" version="">
                            </section>
                            <section id="multiple_alignments" name="Multiple Alignments" version="">
                            </section>
                            <label id="metagenomics_label" text="Metagenomics" version="" />
                            <section id="metagenomic_analysis" name="Metagenomic Analysis" version="">
                            </section>
                            <label id="genomics_toolkits_label" text="Genomics Toolkits" version="" />
                            <section id="picard" name="Picard" version="">
                            </section>
                            <section id="deeptools" name="deepTools" version="">
                            </section>
                            <section id="emboss" name="EMBOSS" version="">
                            </section>
                            <section id="seqtk" name="Seqtk" version="">
                            </section>
                            <label id="statistics_and_visualization_label" text="Statistics and Visualization" version="" />
                            <section id="statistics" name="Statistics" version="">
                                <label id="multiple_regression_label" text="Multiple Regression" version="" />
                                <label id="multivariate_analysis_label" text="Multivariate Analysis" version="" />
                            </section>
                            <section id="special_visualizations" name="Specialized Visualizations">
                            </section>
                            <section id="graph_display_data" name="Graph/Display Data" version="">
                            </section>
                            <section id="textutil" name="Text Manipulation" version="">
                            </section>
                            <section id="motif_tools" name="Motif Tools" version="">
                            </section>
                            <section id="ncbi_blast_" name="NCBI BLAST+" version="">
                            </section>
                        </toolbox>
                      job_conf.xml: |
                        <job_conf>
                            <plugins>
                                <plugin id="local" type="runner" load="galaxy.jobs.runners.local:LocalJobRunner" workers="4" />
                                <plugin id="k8s" type="runner" load="galaxy.jobs.runners.kubernetes:KubernetesJobRunner">
                                  <param id="k8s_use_service_account">true</param>
                                  <param id="k8s_persistent_volume_claims">{{ '{{' }} template "galaxy.pvcname" . {{ '}}' }}:{{ '{{' }}.Values.persistence.mountPath{{ '}}' }},{{ '{{' }} template "galaxy.fullname" . {{ '}}' }}-cvmfs-gxy-data-pvc:{{ '{{' }} .Values.cvmfs.data.mountPath {{ '}}' }},{{ '{{' }} template "galaxy.fullname" . {{ '}}' }}-cvmfs-gxy-main-pvc:{{ '{{' }} .Values.cvmfs.main.mountPath {{ '}}' }}</param>
                                  <param id="k8s_namespace">{{ '{{' }} .Release.Namespace {{ '}}' }}</param>
                                  <!-- Must be DNS friendly and less than 20 characters -->
                                  <param id="k8s_galaxy_instance_id">{{ '{{' }} .Release.Name {{ '}}' }}</param>
                                  <param id="k8s_run_as_user_id">101</param>
                                  <param id="k8s_run_as_group_id">101</param>
                                  <param id="k8s_fs_group_id">101</param>
                                  <param id="k8s_supplemental_group_id">101</param>
                                  <param id="k8s_pull_policy">IfNotPresent</param>
                                  <param id="k8s_cleanup_job">always</param>
                                  <param id="k8s_pod_priority_class">{{ '{{' }} include "galaxy.fullname" . {{ '}}' }}-job-priority</param>
                                  <param id="k8s_affinity">
                                    nodeAffinity:
                                      requiredDuringSchedulingIgnoredDuringExecution:
                                        nodeSelectorTerms:
                                        - matchExpressions:
                                          - key: node-role.kubernetes.io/controlplane
                                            operator: NotIn
                                            values:
                                            - "true"
                                          - key: node-role.kubernetes.io/etcd
                                            operator: NotIn
                                            values:
                                            - "true"
                                  </param>
                                </plugin>
                            </plugins>
                            <handlers assign_with="db-skip-locked" />
                            <destinations default="dynamic-k8s-dispatcher">
                                <destination id="local" runner="local"/>
                                <destination id="dynamic-k8s-dispatcher" runner="dynamic">
                                  <param id="type">python</param>
                                  <param id="function">k8s_container_mapper</param>
                                  <param id="docker_default_container_id">{{ '{{' }} .Values.image.repository {{ '}}' }}:{{ '{{' }} .Values.image.tag {{ '}}' }}</param>
                                  <param id="docker_enabled">true</param>
                                </destination>
                            </destinations>
                            <limits>
                                <limit type="registered_user_concurrent_jobs">10</limit>
                                <limit type="anonymous_user_concurrent_jobs">0</limit>
                            </limits>
                        </job_conf>
                    extraFileMappings:
                      /galaxy/server/static/welcome.html:
                        useSecret: false
                        applyToJob: false
                        applyToWeb: true
                        content: |
                          <!DOCTYPE html>
                          <html lang="en">
                              <head>
                                  <meta charset="utf-8">
                                  <link rel="stylesheet" href="style/base.css" type="text/css" />
                              </head>
                              <body class="m-0">
                                  <div class="py-4">
                                      <div class="container">
                                          <h1>Welcome to <strong>Galaxy Pro</strong></h1>
                                          <p>
                                              Your Galaxy Pro instance is ready for use. Start by
                                              uploading data and selecting tools from the tool panel on
                                              the left. You can also run complex pipelines via workflows
                                              or share data with colleagues and collaborators.
                                          </p>
                                          <h3>Support</h3>
                                          <p>
                                              How can we help? Reach out to us with questions about the service at
                                              <a target="_blank"
                                              href="mailto:support@galaxyworks.io">support@galaxyworks.io</a>.
                                          </p>
                                          <hr />
                                          {{ '{{' }}- if .Values.influxdb.enabled {{ '}}' }}
                                          <h3>Status dashboard</h3>
                                          An overview of the current system state and usage.
                                          <div class="container">
                                              <iframe width="100%" height="1300px" frameborder="0" marginheight="0" marginwidth="0"
                                                  src="/grafana/d/gxy_general_stats_{{ '{{' }} .Release.Name {{ '}}' }}/galaxy-overview?refresh=60s&orgId=1&kiosk&theme=light"></iframe>
                                          </div>
                                          {{ '{{' }}- end {{ '}}' }}
                                      </div>
                                  </div>
                                  <div class="container">
                                      <footer class="text-center">
                                          <p>Copyright Â© 2020 GalaxyWorks LLC. All rights reserved. Galaxy Pro v{{ '{{' }} .Chart.AppVersion {{ '}}' }}.</p>
                                      </footer>
                                  </div>
                              </body>
                          </html>
                    persistence:
                      storageClass: efs
                      size: 1100Gi
                    postgresql:
                      postgresqlPassword: {{ random_client_secret }}
                      postgresqlPostgresPassword: {{ random_client_secret }}
                      master:
                        podAnnotations:
                          backup.velero.io/backup-volumes: data
                        affinity:
                          nodeAffinity:
                            requiredDuringSchedulingIgnoredDuringExecution:
                              nodeSelectorTerms:
                              - matchExpressions:
                                - key: node-role.kubernetes.io/controlplane
                                  operator: In
                                  values:
                                  - "true"
                      persistence:
                        storageClass: ebs
                    ingress:
                      enabled: true
                      annotations:
                         kubernetes.io/tls-acme: "true"
                         cert-manager.io/cluster-issuer: letsencrypt-prod
                         nginx.ingress.kubernetes.io/secure-backends: "true"
                      hosts:
                         - ~
            {% if not (rancher_server | ipaddr) %}
                         - "{{ rancher_server }}"
                      tls:
                         - secretName: "{{ rancher_server | replace('.', '-') }}-key"
                           hosts:
                             - "{{ rancher_server }}"
            {% endif %}
                      path: /initial/galaxy

            cloudlaunch:
               rabbitmq:
                  rabbitmqErlangCookie: {{ random_client_secret }}{{ random_client_secret }}
               image:
                  repository: galaxyworks/cloudman-ui-pro
                  tag: 1.0.0
               resources:
                  requests:
                    cpu: 100m
                    memory: 500Mi
                  limits:
                    cpu: 1000m
                    memory: 3000Mi
               affinity:
                  nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                      nodeSelectorTerms:
                      - matchExpressions:
                        - key: node-role.kubernetes.io/controlplane
                          operator: In
                          values:
                          - "true"
               cloudlaunchserver:
                  image:
                    repository: galaxyworks/cloudman-server
                    tag: 1.0.0
                  podAnnotations:
                    iam.amazonaws.com/role: "{{ cm_deployment_name }}-gxy-pro-cm-node"
                  resources:
                    requests:
                      cpu: 500m
                      memory: 1500Mi
                    limits:
                      cpu: 1000m
                      memory: 5000Mi
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: node-role.kubernetes.io/controlplane
                            operator: In
                            values:
                            - "true"
                  admin_password: "{{ rancher_password }}"
                  postgresql:
                     postgresqlPassword: {{ random_client_secret }}
                     postgresqlPostgresPassword: {{ random_client_secret }}
                     persistence:
                        storageClass: "ebs"
                     master:
                        affinity:
                          nodeAffinity:
                            requiredDuringSchedulingIgnoredDuringExecution:
                              nodeSelectorTerms:
                              - matchExpressions:
                                - key: node-role.kubernetes.io/controlplane
                                  operator: In
                                  values:
                                  - "true"
                  ingress:
                     annotations:
                        kubernetes.io/tls-acme: "true"
                        cert-manager.io/cluster-issuer: letsencrypt-prod
                        nginx.ingress.kubernetes.io/secure-backends: "true"
                     hosts:
                        - ~
            {% if not (rancher_server | ipaddr) %}
                        - "{{ rancher_server }}"
                     tls:
                        - secretName: "{{ rancher_server | replace('.', '-') }}-key"
                          hosts:
                            - "{{ rancher_server }}"
            {% endif %}
               ingress:
                  annotations:
                     kubernetes.io/tls-acme: "true"
                     cert-manager.io/cluster-issuer: letsencrypt-prod
                     nginx.ingress.kubernetes.io/secure-backends: "true"
                  hosts:
                     - ~
            {% if not (rancher_server | ipaddr) %}
                     - "{{ rancher_server }}"
                  tls:
                     - secretName: "{{ rancher_server | replace('.', '-') }}-key"
                       hosts:
                         - "{{ rancher_server }}"
            {% endif %}
            prometheus:
               prometheusSpec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: node-role.kubernetes.io/controlplane
                            operator: In
                            values:
                            - "true"
               prometheusOperator:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: node-role.kubernetes.io/controlplane
                            operator: In
                            values:
                            - "true"
               persistence:
                  storageClass: "efs"
               alertmanager:
                  alertmanagerSpec:
                     affinity:
                       nodeAffinity:
                         requiredDuringSchedulingIgnoredDuringExecution:
                           nodeSelectorTerms:
                           - matchExpressions:
                             - key: node-role.kubernetes.io/controlplane
                               operator: In
                               values:
                               - "true"
                  config:
                     global:
                       smtp_smarthost: {{ galaxy_pro_smtp_server }}
                       smtp_from: 'alerts@{{ rancher_server }}'
                       smtp_auth_username: {{ galaxy_pro_smtp_username }}
                       smtp_auth_password: {{ galaxy_pro_smtp_password }}
                       smtp_require_tls: false
                       http_config:
                          basic_auth:
                             password: {{ random_client_secret }}
                     receivers:
                       - name: 'scaleup'
                         webhook_configs:
                           - url: http://{{ '{{' }} .Release.Name {{ '}}' }}-cloudlaunchserver:8000/cloudman/api/v1/clusters/1/signals/scaleup/
                             send_resolved: false
                       - name: 'scaledown'
                         webhook_configs:
                           - url: http://{{ '{{' }} .Release.Name {{ '}}' }}-cloudlaunchserver:8000/cloudman/api/v1/clusters/1/signals/scaledown/
                             send_resolved: false
                       - name: 'blackhole'
                       - name: 'email'
                         email_configs:
                           - to: support@galaxyworks.io
                     route:
                       group_by:
                         - alertname
                       receiver: 'blackhole'
                       group_interval: 5m
                       group_wait: 30s
                       repeat_interval: 8h
                       routes:
                         - match:
                             alertname: ClusterOverUtilized
                           receiver: 'scaleup'
                           group_interval: 2m
                           group_wait: 30s
                           repeat_interval: 5m
                         - match:
                             alertname: ClusterUnderUtilized
                           receiver: 'scaledown'
                           group_interval: 2m
                           group_wait: 30s
                           repeat_interval: 5m
                         - match:
                             severity: critical
                           receiver: 'email'
               grafana:
                  adminPassword: {{ random_client_secret }}
                  affinity:
                     nodeAffinity:
                       requiredDuringSchedulingIgnoredDuringExecution:
                         nodeSelectorTerms:
                         - matchExpressions:
                           - key: node-role.kubernetes.io/controlplane
                             operator: In
                             values:
                             - "true"
                  grafana.ini:
                     server:
                        root_url: "https://{{ rancher_server }}/grafana"
                     auth.generic_oauth:
                        auth_url: "https://{{ rancher_server }}/auth/realms/master/protocol/openid-connect/auth"
                        token_url: "https://{{ rancher_server }}/auth/realms/master/protocol/openid-connect/token"
                        api_url: "https://{{ rancher_server }}/auth/realms/master/protocol/openid-connect/userinfo"
                  ingress:
                     annotations:
                        kubernetes.io/tls-acme: "true"
                        cert-manager.io/cluster-issuer: letsencrypt-prod
                        nginx.ingress.kubernetes.io/secure-backends: "true"
                     hosts:
                        - ~
            {% if not (rancher_server | ipaddr) %}
                        - "{{ rancher_server }}"
                     tls:
                        - secretName: "{{ rancher_server | replace('.', '-') }}-key"
                          hosts:
                            - "{{ rancher_server }}"
            {% endif %}
            keycloak:
               keycloak:
                   resources:
                     requests:
                        cpu: 100m
                        memory: 750Mi
                     limits:
                        cpu: 1000m
                        memory: 2000Mi
                   affinity: |
                     podAntiAffinity:
                       requiredDuringSchedulingIgnoredDuringExecution:
                         - labelSelector:
                             matchLabels:
                               {{ '{{' }}- include "keycloak.selectorLabels" . | nindent 10 {{ '}}' }}
                             matchExpressions:
                               - key: role
                                 operator: NotIn
                                 values:
                                   - test
                           topologyKey: kubernetes.io/hostname
                       preferredDuringSchedulingIgnoredDuringExecution:
                         - weight: 100
                           podAffinityTerm:
                             labelSelector:
                               matchLabels:
                                 {{ '{{' }}- include "keycloak.selectorLabels" . | nindent 12 {{ '}}' }}
                               matchExpressions:
                                 - key: role
                                   operator: NotIn
                                   values:
                                     - test
                             topologyKey: failure-domain.beta.kubernetes.io/zone
                     nodeAffinity:
                       requiredDuringSchedulingIgnoredDuringExecution:
                         nodeSelectorTerms:
                         - matchExpressions:
                           - key: node-role.kubernetes.io/controlplane
                             operator: In
                             values:
                             - "true"
                   password: "{{ rancher_password }}"
                   ingress:
                     enabled: true
                     path: /auth
                     annotations:
                        kubernetes.io/tls-acme: "true"
                        cert-manager.io/cluster-issuer: letsencrypt-prod
                        nginx.ingress.kubernetes.io/secure-backends: "true"
                     hosts:
                        - ~
            {% if not (rancher_server | ipaddr) %}
                        - "{{ rancher_server }}"
                     tls:
                        - secretName: "{{ rancher_server | replace('.', '-') }}-key"
                          hosts:
                            - "{{ rancher_server }}"
            {% endif %}
                   extraInitContainers: |
                     - name: theme-provider
                       image: galaxyworks/galaxy-pro-keycloak-theme:1.0.0
                       imagePullPolicy: IfNotPresent
                       command:
                         - sh
                       args:
                         - -c
                         - |
                           echo "Copying theme..."
                           cp -R /customtheme/* /theme
                           echo "done."
                       volumeMounts:
                         - name: theme
                           mountPath: /theme
            influxdb:
              setDefaultUser:
                password: {{ random_client_secret }}
            global:
               domain: "{{ rancher_server }}"
               deployment_name: "{{ cm_deployment_name }}"
    - version: dev
      frontend_component_path: |-
        app/marketplace/plugins/plugins.module#PluginsModule
      frontend_component_name: clui-cm2-config
      backend_component_name: |-
        galaxy-pro-launch.plugins.galaxy_pro_app.GalaxyProApp
      default_launch_config:
        config_appliance:
          runner: ansible
          sshUser: ubuntu
          playbooks:
            - url: https://github.com/CloudVE/cloudman-boot
              ordinal: 0
              inventory_template: |-
                [controllers]
                ${host}

                [agents]

                [rke_cluster:children]
                controllers
                agents

                [all:vars]
                ansible_ssh_port=22
                ansible_user='${user}'
                ansible_ssh_private_key_file=pk
                ansible_ssh_extra_args='-o StrictHostKeyChecking=no'
            - url: https://github.com/galaxy-works/galaxy-pro-boot
              ordinal: 1
              inventory_template: |-
                ${host}

                [all:vars]
                ansible_ssh_port=22
                ansible_user='${user}'
                ansible_ssh_private_key_file=pk
                ansible_ssh_extra_args='-o StrictHostKeyChecking=no'
        config_cloudlaunch:
          firewall:
          - rules:
            - cidr: 0.0.0.0/0
              from: '22'
              protocol: tcp
              to: '22'
            - cidr: 0.0.0.0/0
              from: '80'
              protocol: tcp
              to: '80'
            - cidr: 0.0.0.0/0
              from: '443'
              protocol: tcp
              to: '443'
            - cidr: 0.0.0.0/0
              from: '4430'
              protocol: tcp
              to: '4430'
            - cidr: 0.0.0.0/0
              from: '6443'
              protocol: tcp
              to: '6443'
            - cidr: 0.0.0.0/0
              from: '2379'
              protocol: tcp
              to: '2380'
            - cidr: 0.0.0.0/0
              from: '10250'
              protocol: tcp
              to: '10250'
            - cidr: 0.0.0.0/0
              from: '10251'
              protocol: tcp
              to: '10251'
            - cidr: 0.0.0.0/0
              from: '10252'
              protocol: tcp
              to: '10252'
            - cidr: 0.0.0.0/0
              from: '10256'
              protocol: tcp
              to: '10256'
            - cidr: 0.0.0.0/0
              from: '30000'
              protocol: tcp
              to: '32767'
            - from: '1'
              protocol: tcp
              src_group: cloudlaunch-cm2
              to: '65535'
            - from: '1'
              protocol: udp
              src_group: cloudlaunch-cm2
              to: '65535'
            securityGroup: cloudlaunch-cm2
          vmType: m1.medium
        config_cloudman2:
          cm_charts_repo: https://raw.githubusercontent.com/galaxy-works/helm-charts/master/
          cm_helm_values: |
            cluster_type: KUBE_RKE
            rke_registration_server: {{ rke_registration_server }}
            rke_registration_token: {{ rke_registration_token }}

            helmsman_config:
              repositories:
                 - name: galaxyworks
                   url: https://raw.githubusercontent.com/galaxy-works/helm-charts/master/
              template_registries:
                - https://raw.githubusercontent.com/galaxy-works/galaxy-pro-launch-app-registry/master/template-registry.yaml

            projman_config:
              projects:
                initial:
                  charts:
                    galaxy:
                      install_template: galaxy

            cloudlaunch:
               rabbitmq:
                  rabbitmqErlangCookie: {{ random_client_secret }}
               image:
                  repository: galaxyworks/cloudman-ui-pro
                  tag: latest
               resources:
                  requests:
                    cpu: 100m
                    memory: 500Mi
                  limits:
                    cpu: 1000m
                    memory: 3000Mi
               affinity:
                  nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                      nodeSelectorTerms:
                      - matchExpressions:
                        - key: node-role.kubernetes.io/controlplane
                          operator: In
                          values:
                          - "true"
               cloudlaunchserver:
                  image:
                    repository: galaxyworks/cloudman-server
                    tag: latest
                  podAnnotations:
                    iam.amazonaws.com/role: "{{ cm_deployment_name }}-gxy-pro-cm-node"
                  resources:
                    requests:
                      cpu: 500m
                      memory: 1500Mi
                    limits:
                      cpu: 1000m
                      memory: 5000Mi
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: node-role.kubernetes.io/controlplane
                            operator: In
                            values:
                            - "true"
                  admin_password: "{{ cluster_password }}"
                  postgresql:
                     postgresqlPassword: {{ random_client_secret }}
                     postgresqlPostgresPassword: {{ random_client_secret }}
                     persistence:
                        storageClass: "ebs"
                     master:
                        affinity:
                          nodeAffinity:
                            requiredDuringSchedulingIgnoredDuringExecution:
                              nodeSelectorTerms:
                              - matchExpressions:
                                - key: node-role.kubernetes.io/controlplane
                                  operator: In
                                  values:
                                  - "true"
                  ingress:
                     annotations:
                        kubernetes.io/tls-acme: "true"
                        cert-manager.io/cluster-issuer: letsencrypt-prod
                        nginx.ingress.kubernetes.io/secure-backends: "true"
                     hosts:
                        - ~
            {% if not (cluster_hostname | ipaddr) %}
                        - "{{ cluster_hostname }}"
                     tls:
                        - secretName: "{{ cluster_hostname | replace('.', '-') }}-key"
                          hosts:
                            - "{{ cluster_hostname }}"
            {% endif %}
               ingress:
                  annotations:
                     kubernetes.io/tls-acme: "true"
                     cert-manager.io/cluster-issuer: letsencrypt-prod
                     nginx.ingress.kubernetes.io/secure-backends: "true"
                  hosts:
                     - ~
            {% if not (cluster_hostname | ipaddr) %}
                     - "{{ cluster_hostname }}"
                  tls:
                     - secretName: "{{ cluster_hostname | replace('.', '-') }}-key"
                       hosts:
                         - "{{ cluster_hostname }}"
            {% endif %}
            prometheus:
               prometheusSpec:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: node-role.kubernetes.io/controlplane
                            operator: In
                            values:
                            - "true"
               prometheusOperator:
                  affinity:
                    nodeAffinity:
                      requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                        - matchExpressions:
                          - key: node-role.kubernetes.io/controlplane
                            operator: In
                            values:
                            - "true"
               persistence:
                  storageClass: "efs"
               alertmanager:
                  alertmanagerSpec:
                     affinity:
                       nodeAffinity:
                         requiredDuringSchedulingIgnoredDuringExecution:
                           nodeSelectorTerms:
                           - matchExpressions:
                             - key: node-role.kubernetes.io/controlplane
                               operator: In
                               values:
                               - "true"
                  config:
                     global:
                       smtp_smarthost: {{ galaxy_pro_smtp_server }}
                       smtp_from: 'alerts@{{ cluster_hostname }}'
                       smtp_auth_username: {{ galaxy_pro_smtp_username }}
                       smtp_auth_password: {{ galaxy_pro_smtp_password }}
                       smtp_require_tls: false
                       http_config:
                          basic_auth:
                             password: {{ random_client_secret }}
                     receivers:
                       - name: 'scaleup'
                         webhook_configs:
                           - url: http://{{ '{{' }} .Release.Name {{ '}}' }}-cloudlaunchserver:8000/cloudman/api/v1/clusters/1/signals/scaleup/
                             send_resolved: false
                       - name: 'scaledown'
                         webhook_configs:
                           - url: http://{{ '{{' }} .Release.Name {{ '}}' }}-cloudlaunchserver:8000/cloudman/api/v1/clusters/1/signals/scaledown/
                             send_resolved: false
                       - name: 'blackhole'
                       - name: 'email'
                         email_configs:
                           - to: support@galaxyworks.io
                     route:
                       group_by:
                         - alertname
                       receiver: 'blackhole'
                       group_interval: 5m
                       group_wait: 30s
                       repeat_interval: 8h
                       routes:
                         - match:
                             alertname: ClusterOverUtilized
                           receiver: 'scaleup'
                           group_interval: 2m
                           group_wait: 30s
                           repeat_interval: 5m
                         - match:
                             alertname: ClusterUnderUtilized
                           receiver: 'scaledown'
                           group_interval: 2m
                           group_wait: 30s
                           repeat_interval: 5m
                         - match:
                             severity: critical
                           receiver: 'email'
               grafana:
                  adminPassword: {{ random_client_secret }}
                  affinity:
                     nodeAffinity:
                       requiredDuringSchedulingIgnoredDuringExecution:
                         nodeSelectorTerms:
                         - matchExpressions:
                           - key: node-role.kubernetes.io/controlplane
                             operator: In
                             values:
                             - "true"
                  grafana.ini:
                     server:
                        root_url: "https://{{ cluster_hostname }}/grafana"
                     auth.generic_oauth:
                        auth_url: "https://{{ cluster_hostname }}/auth/realms/master/protocol/openid-connect/auth"
                        token_url: "https://{{ cluster_hostname }}/auth/realms/master/protocol/openid-connect/token"
                        api_url: "https://{{ cluster_hostname }}/auth/realms/master/protocol/openid-connect/userinfo"
                  ingress:
                     annotations:
                        kubernetes.io/tls-acme: "true"
                        cert-manager.io/cluster-issuer: letsencrypt-prod
                        nginx.ingress.kubernetes.io/secure-backends: "true"
                     hosts:
                        - ~
            {% if not (cluster_hostname | ipaddr) %}
                        - "{{ cluster_hostname }}"
                     tls:
                        - secretName: "{{ cluster_hostname | replace('.', '-') }}-key"
                          hosts:
                            - "{{ cluster_hostname }}"
            {% endif %}
            keycloak:
               keycloak:
                   resources:
                     requests:
                        cpu: 100m
                        memory: 750Mi
                     limits:
                        cpu: 1000m
                        memory: 2000Mi
                   affinity: |
                     podAntiAffinity:
                       requiredDuringSchedulingIgnoredDuringExecution:
                         - labelSelector:
                             matchLabels:
                               {{ '{{' }}- include "keycloak.selectorLabels" . | nindent 10 {{ '}}' }}
                             matchExpressions:
                               - key: role
                                 operator: NotIn
                                 values:
                                   - test
                           topologyKey: kubernetes.io/hostname
                       preferredDuringSchedulingIgnoredDuringExecution:
                         - weight: 100
                           podAffinityTerm:
                             labelSelector:
                               matchLabels:
                                 {{ '{{' }}- include "keycloak.selectorLabels" . | nindent 12 {{ '}}' }}
                               matchExpressions:
                                 - key: role
                                   operator: NotIn
                                   values:
                                     - test
                             topologyKey: failure-domain.beta.kubernetes.io/zone
                     nodeAffinity:
                       requiredDuringSchedulingIgnoredDuringExecution:
                         nodeSelectorTerms:
                         - matchExpressions:
                           - key: node-role.kubernetes.io/controlplane
                             operator: In
                             values:
                             - "true"
                   password: "{{ cluster_password }}"
                   ingress:
                     enabled: true
                     path: /auth
                     annotations:
                        kubernetes.io/tls-acme: "true"
                        cert-manager.io/cluster-issuer: letsencrypt-prod
                        nginx.ingress.kubernetes.io/secure-backends: "true"
                     hosts:
                        - ~
            {% if not (cluster_hostname | ipaddr) %}
                        - "{{ cluster_hostname }}"
                     tls:
                        - secretName: "{{ cluster_hostname | replace('.', '-') }}-key"
                          hosts:
                            - "{{ cluster_hostname }}"
            {% endif %}
                   extraInitContainers: |
                     - name: theme-provider
                       image: galaxyworks/galaxy-pro-keycloak-theme:1.0.0
                       imagePullPolicy: IfNotPresent
                       command:
                         - sh
                       args:
                         - -c
                         - |
                           echo "Copying theme..."
                           cp -R /customtheme/* /theme
                           echo "done."
                       volumeMounts:
                         - name: theme
                           mountPath: /theme
            influxdb:
              setDefaultUser:
                password: {{ random_client_secret }}
            global:
               domain: "{{ cluster_hostname }}"
               deployment_name: "{{ cm_deployment_name }}"
